<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini Cloud Platform</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #0f0f23; 
            color: #fff;
            line-height: 1.6;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        .card { 
            background: #1a1a2e; 
            border-radius: 8px; 
            padding: 1.5rem; 
            margin-bottom: 1rem;
            border: 1px solid #2d3748;
        }
        .btn { 
            background: #4299e1; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 4px; 
            cursor: pointer;
            margin: 2px;
        }
        .btn:hover { background: #3182ce; }
        .btn-danger { background: #e53e3e; }
        .btn-danger:hover { background: #c53030; }
        .btn-success { background: #38a169; }
        .btn-success:hover { background: #2f855a; }
        .status-running { color: #48bb78; }
        .status-stopped { color: #e53e3e; }
        .status-building { color: #ed8936; }
        .app-grid { display: grid; gap: 1rem; }
        .form-group { margin-bottom: 1rem; }
        .form-input { 
            width: 100%; 
            padding: 10px; 
            background: #2d3748; 
            border: 1px solid #4a5568; 
            border-radius: 4px; 
            color: white;
        }
        .logs { 
            background: #000; 
            color: #00ff00; 
            padding: 1rem; 
            border-radius: 4px; 
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .metric { text-align: center; padding: 1rem; background: #2d3748; border-radius: 8px; }
        .metric-value { font-size: 2rem; font-weight: bold; color: #4299e1; }
        .metric-label { color: #a0aec0; font-size: 0.9rem; }
        .health-healthy { color: #48bb78; }
        .health-unhealthy { color: #e53e3e; }
    </style>
</head>
<body>
    <div class="container" x-data="{ 
        apps: [], 
        stats: {},
        newApp: { name: '', git_url: '' },
        showDeployForm: false,
        selectedApp: null,
        logs: '',
        loadAppHealth,
        loadApps,
        loadStats
    }" 
    x-init="
        await loadApps.call(this);
        await loadStats.call(this);
        setInterval(() => loadApps.call(this), 5000);
    ">
        <!-- Header -->
        <div class="header">
            <h1>üöÄ Mini Cloud Platform</h1>
            <p>Deploy and manage your applications</p>
            <div style="margin-top: 1rem;">
                <span>üìä Apps: <span x-text="stats.running_apps || 0"></span> running / <span x-text="stats.total_apps || 0"></span> total</span>
            </div>
        </div>

        <!-- Monitoring Section -->
        <div class="card">
            <h3>üìä Platform Monitoring</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                <div class="metric">
                    <div class="metric-value" x-text="stats.total_apps || 0"></div>
                    <div class="metric-label">Total Apps</div>
                </div>
                <div class="metric">
                    <div class="metric-value" x-text="stats.running_apps || 0"></div>
                    <div class="metric-label">Running Apps</div>
                </div>
                <div class="metric">
                    <div class="metric-value" x-text="stats.healthy_apps || 0"></div>
                    <div class="metric-label">Healthy Apps</div>
                </div>
            </div>
        </div>

        <!-- Deploy Form -->
        <div class="card">
            <button @click="showDeployForm = !showDeployForm" class="btn">
                üöÄ <span x-text="showDeployForm ? 'Cancel' : 'Deploy New App'"></span>
            </button>
            
            <div x-show="showDeployForm" style="margin-top: 1rem;">
                <div class="form-group">
                    <label>App Name</label>
                    <input x-model="newApp.name" class="form-input" placeholder="my-awesome-app">
                </div>
                <div class="form-group">
                    <label>Git Repository URL</label>
                    <input x-model="newApp.git_url" class="form-input" 
                           placeholder="https://github.com/username/repo.git">
                </div>
                <button @click="deployApp()" class="btn btn-success">Deploy Application</button>
            </div>
        </div>

        <!-- Applications Grid -->
        <div class="app-grid">
            <template x-for="app in apps" :key="app.id">
                <div class="card">
                    <div style="display: flex; justify-content: between; align-items: start;">
                        <div style="flex: 1;">
                            <h3 x-text="app.name"></h3>
                            <p>üÜî <span x-text="app.id"></span></p>
                            <p>üåê <a :href="app.url" target="_blank" x-text="app.url"></a></p>
                            <p>‚è∞ <span x-text="new Date(app.created_at).toLocaleString()"></span></p>
                            <p>
                                Status: 
                                <span :class="'status-' + app.status" x-text="app.status.toUpperCase()"></span>
                                <span x-show="app.health" :class="'health-' + app.health.status" 
                                      x-text="'(' + app.health.status + ')'"></span>
                            </p>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <template x-if="app.status === 'running'">
                                <button @click="stopApp(app.id)" class="btn btn-danger">Stop</button>
                            </template>
                            <template x-if="app.status === 'stopped'">
                                <button @click="startApp(app.id)" class="btn btn-success">Start</button>
                            </template>
                            <button @click="restartApp(app.id)" class="btn">Restart</button>
                            <button @click="viewLogs(app.id)" class="btn">View Logs</button>
                            <button @click="deleteApp(app.id)" class="btn btn-danger">Delete</button>
                        </div>
                    </div>
                    
                    <!-- Logs Section -->
                    <div x-show="selectedApp === app.id" style="margin-top: 1rem;">
                        <h4>Application Logs</h4>
                        <div class="logs" x-text="logs"></div>
                        <button @click="loadLogs(app.id)" class="btn" style="margin-top: 0.5rem;">Refresh Logs</button>
                    </div>
                </div>
            </template>
        </div>

        <!-- Empty State -->
        <div x-show="apps.length === 0" class="card" style="text-align: center;">
            <h3>No applications deployed yet</h3>
            <p>Deploy your first application using the form above!</p>
        </div>
    </div>

    <script>
        function loadAppHealth() {
            this.apps.forEach(app => {
                fetch(`/api/apps/${app.id}/health`)
                    .then(r => r.json())
                    .then(health => { app.health = health; });
            });
        }

        function loadApps() {
            return fetch('/api/apps')
                .then(r => r.json())
                .then(data => { 
                    this.apps = data;
                    this.loadAppHealth();
                });
        }

        function loadStats() {
            return fetch('/api/stats')
                .then(r => r.json())
                .then(data => { 
                    this.stats = data;
                    this.stats.healthy_apps = this.apps.filter(app => 
                        app.health && app.health.status === 'healthy'
                    ).length;
                });
        }

        function deployApp() {
            const appData = this.newApp;
            fetch('/api/deploy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(appData)
            })
            .then(r => r.json())
            .then(result => {
                alert('Deployment started! Check the app list for status.');
                this.newApp = { name: '', git_url: '' };
                this.showDeployForm = false;
                loadApps.call(this);
            })
            .catch(err => alert('Deployment failed: ' + err));
        }

        function startApp(appId) {
            fetch(`/api/apps/${appId}/start`, { method: 'POST' })
                .then(() => loadApps.call(this));
        }

        function stopApp(appId) {
            fetch(`/api/apps/${appId}/stop`, { method: 'POST' })
                .then(() => loadApps.call(this));
        }

        function restartApp(appId) {
            fetch(`/api/apps/${appId}/restart`, { method: 'POST' })
                .then(() => loadApps.call(this));
        }

        function deleteApp(appId) {
            if (confirm('Are you sure you want to delete this app?')) {
                fetch(`/api/apps/${appId}`, { method: 'DELETE' })
                    .then(() => {
                        this.selectedApp = null;
                        loadApps.call(this);
                    });
            }
        }

        function viewLogs(appId) {
            this.selectedApp = this.selectedApp === appId ? null : appId;
            if (this.selectedApp) {
                this.loadLogs(appId);
            }
        }

        function loadLogs(appId) {
            fetch(`/api/apps/${appId}/logs?lines=50`)
                .then(r => r.json())
                .then(data => { this.logs = data.logs; });
        }
    </script>
</body>
</html>